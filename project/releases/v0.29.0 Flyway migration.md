# v0.29.0 Flyway Migration

Molecule now includes a type-safe database migration system that generates Flyway-compatible SQL from domain structure changes.

### How it works

```scala
// 1. Add a migration marker to an attribute in your domain structure
trait Person {
  val name = oneString.rename("fullName")
}

// 2. Run: sbt moleculeGen

// 3. Marker automatically cleaned up and attribute renamed
trait Person {
  val fullName = oneString
}

// 4. Molecule generates Flyway SQL migration file

// 5. Run Flyway migration
```

No need to write SQL migrations manually! (Although you can too if you want to)

## Migration Markers

Use migration markers to mark changes to domain elements in your domain structure, and Molecule will generate SQL to migrate your database:

**Segments:**
```scala
object analytics extends Remove
object oldSegment extends Rename("newSegment")
```

**Entities:**
```scala
trait Customer extends Remove
trait OldEntity extends Rename("NewEntity")
```

**Attributes:**
```scala
trait Person {
  val email = oneString.remove
  val oldName = oneString.rename("fullName")
  val phone = oneString  // Additions auto-detected
}
```

**Relationships:**
```scala
trait Order {
  val customer = manyToOne[Customer].remove
  val user = manyToOne[User].rename("account")
  val company = manyToOne[Company].owner  // ON DELETE CASCADE
}
```


### Ambiguous Changes

When attributes or relationships disappear without explicit markers, Molecule generates a helper file requiring you to choose `.remove` or `.rename("newName")`. For entities and segments, explicit markers must be added directly to your domain file. This keeps the migration system type-safe and avoids silent data loss.

## Safety

**Name swaps prevented:** Detects 2-way swaps and N-way cyclical renames (A → B → C → A), provides guidance on breaking cycles using temporary names.

**Type/cardinality changes blocked:** Prevents automatic migrations when types or cardinalities change. Provides a 5-step manual migration guide to ensure safe data transformation.

## Database Support

H2, PostgreSQL, MySQL, MariaDB, SQLite. Each database generates appropriate SQL syntax for migrations.

## Automatic Features

**Additions auto-detected:** New segments, entities, attributes, and relationships are automatically detected and added.

**Foreign keys managed:** Relationship migrations handle foreign key constraints, indexes, and CASCADE options automatically.

**Index changes:** Changes to `.index` and `.owner` options are detected and migrated.

**Cleanup:** Migration markers are automatically removed after SQL generation, with optional AST-based codebase renaming for attribute usages.



## Setup

```scala
// project/plugins.sbt
addSbtPlugin("org.scalamolecule" % "sbt-molecule" % "1.24.0")
addSbtPlugin("io.github.davidmweber" % "flyway-sbt" % "7.4.0")

// build.sbt
libraryDependencies += "org.scalamolecule" %% "molecule-db-{dialect}" % "0.29.0"
```

## Read more

Read the full [migration documentation](https://scala-molecule.org/database/migration/overview)
